# pysparkTest

---
### Небольшая тестовая программа для просмотра возможностей Spark:

В PySpark приложении датафреймами (pyspark.sql.DataFrame) задать
продукты, категории и их связи. Каждому продукту может соответствовать
несколько категорий или ни одной. А каждой категории может соответствовать
несколько продуктов или ни одного. Напишите метод на PySpark, который в одном
датафрейме вернет все пары «Имя продукта – Имя категории» и имена всех продуктов,
у которых нет категорий.

---
## Описание
Для тестовой отработки были созданы 3 файла (с рандомной внутренней генерацией):
 1) product.csv - Для хранения информации о продуктах (ProductId, ProductName).
 2) category.csv - Для хранения информации о категориях (CategoryID, CategoryName).
 3) matches.csv - Для хранения информации о пересечениях (CategoryID, ProductId).

Для начала были созданы 3 соответствующих Spark датафрейма из csv файлов:
```
def main():
    # из созданных csv создаём DataFrame-ы
    df_product = spark.read.option("delimiter", ";").option("header", True).csv("product.csv")
    df_category = spark.read.option("delimiter", ";").option("header", True).csv("category.csv")
    df_matches = spark.read.option("delimiter", ";").option("header", True).csv("matches.csv")
    # выведем датафреймы на экран
    print(df_product.show(100), df_category.show(100), df_matches.show(100))
```

Результат:
```
+---------+--------------------+
|ProductID|         ProductName|
+---------+--------------------+
|        1|          Кофемашина|
|        2|         Холодильник|
|        3|           Телевизор|
|        4|       Микроволновка|
|        5|             Пылесос|
|        6|             Блендер|
|        7|                 Фен|
|        8|                Утюг|
|        9|      Пылесос ручной|
|       10|           Кофеварка|
|       11|         Мультиварка|
|       12|              Чайник|
|       13|              Тостер|
|       14|       Плита газовая|
|       15| Плита электрическая|
|       16|             Духовка|
|       17|Посудомоечная машина|
|       18|     Варочная панель|
|       19|             Вытяжка|
|       20|       Соковыжималка|
|       21|           Мясорубка|
|       22|          Хлебопечка|
|       23|             Барбекю|
|       24|               Гриль|
|       25|              Миксер|
|       26|    Кухонный комбайн|
|       27|  Морозильная камера|
|       28|         Винный шкаф|
|       29|              Бойлер|
|       30|         Кондиционер|
|       31|          Вентилятор|
|       32|        Обогреватель|
|       33|       Пылесос-робот|
|       34| Увлажнитель воздуха|
|       35|            Диффузор|
|       36|    Массажное кресло|
|       37|       Электрочайник|
|       38|          Умные часы|
|       39|            Смартфон|
|       40|             Планшет|
|       41|             Ноутбук|
|       42|           Компьютер|
|       43|             Принтер|
|       44|              Сканер|
|       45|              Роутер|
|       46|             Монитор|
|       47|     Телевизор Smart|
|       48|         Фотоаппарат|
|       49|         Видеокамера|
|       50|Аккумуляторная ба...|
+---------+--------------------+

+----------+--------------------+
|CategoryID|        CategoryName|
+----------+--------------------+
|         1|Крупнаябытоваятех...|
|         2|Мелкаябытоваятехника|
|         3|     Техникадлякухни|
|         4|Климатическаятехника|
|         5| Гаджетыиэлектроника|
|         6|   Фотоивидеотехника|
|         7| Компьютерыиноутбуки|
|         8|  Смартфоныипланшеты|
|         9|Аксессуарыдлягадж...|
|        10|  Аудиоивидеотехника|
+----------+--------------------+

+----------+---------+
|CategoryID|ProductID|
+----------+---------+
|         1|       28|
|         2|       14|
|         3|       44|
|         4|        7|
|         5|       33|
|         6|        3|
|         7|       18|
|         8|       22|
|         9|       49|
|        10|        9|
|         1|       15|
|         2|       45|
|         3|       45|
|         7|       41|
|         1|       30|
+----------+---------+

```

Основным объектом является функция (как бы метод ;) **get_product_category_pairs_with_no_category** 

Код функции:
```
def get_product_category_pairs_with_no_category(df_product, df_category, df_matches):
    # делаем inner join для пересечений и категорий
    df_joined_category = df_matches.join(df_category, df_category.CategoryID == df_matches.CategoryID, "inner")

    # делаем left join для продуктов и пересечений, что бы включить продукты без категорий
    # включим в содержание нового DataFrame-а только ProductName и CategoryName колонки
    # Отсортируем по категориям в порядке убывания
    df_joined_category_product = df_product.join(df_joined_category,
                                                 df_product.ProductID == df_joined_category.ProductID, "left")\
                                            .select(df_product.ProductName, df_joined_category.CategoryName)\
                                            .sort(desc(df_joined_category.CategoryName))

    return df_joined_category_product
```
Далее вызов:
```
    df_merged = get_product_category_pairs_with_no_category(df_product, df_category, df_matches)
    print(df_merged.show(100))
```
Результат:
```
+--------------------+--------------------+
|         ProductName|        CategoryName|
+--------------------+--------------------+
|           Телевизор|   Фотоивидеотехника|
|              Сканер|     Техникадлякухни|
|              Роутер|     Техникадлякухни|
|          Хлебопечка|  Смартфоныипланшеты|
|       Плита газовая|Мелкаябытоваятехника|
|              Роутер|Мелкаябытоваятехника|
|         Кондиционер|Крупнаябытоваятех...|
| Плита электрическая|Крупнаябытоваятех...|
|         Винный шкаф|Крупнаябытоваятех...|
|             Ноутбук| Компьютерыиноутбуки|
|     Варочная панель| Компьютерыиноутбуки|
|                 Фен|Климатическаятехника|
|       Пылесос-робот| Гаджетыиэлектроника|
|      Пылесос ручной|  Аудиоивидеотехника|
|         Видеокамера|Аксессуарыдлягадж...|
|          Кофемашина|                null|
|         Холодильник|                null|
|              Чайник|                null|
|       Микроволновка|                null|
|             Блендер|                null|
|              Тостер|                null|
|             Вытяжка|                null|
|               Гриль|                null|
|             Пылесос|                null|
|                Утюг|                null|
|           Кофеварка|                null|
|             Монитор|                null|
|             Духовка|                null|
|       Соковыжималка|                null|
|           Мясорубка|                null|
|              Миксер|                null|
|    Кухонный комбайн|                null|
|              Бойлер|                null|
|        Обогреватель|                null|
|            Диффузор|                null|
|       Электрочайник|                null|
|            Смартфон|                null|
|         Мультиварка|                null|
|     Телевизор Smart|                null|
|         Фотоаппарат|                null|
|Посудомоечная машина|                null|
|             Барбекю|                null|
|  Морозильная камера|                null|
|          Вентилятор|                null|
| Увлажнитель воздуха|                null|
|    Массажное кресло|                null|
|          Умные часы|                null|
|             Планшет|                null|
|           Компьютер|                null|
|             Принтер|                null|
|Аккумуляторная ба...|                null|
+--------------------+--------------------+
```

Вот такой получился пример програмки для тестирования Spark DataFrame-ов :)

---